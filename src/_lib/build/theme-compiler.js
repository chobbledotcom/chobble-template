/**
 * Theme compiler - generates combined CSS from individual theme-*.scss files.
 *
 * Reads theme files from src/css/, extracts CSS variables from :root blocks,
 * and generates a theme-switcher stylesheet with:
 * - html[data-theme="name"] selectors for each theme
 * - Theme metadata in CSS custom properties for JavaScript access
 *
 * Output format (generated SCSS):
 * - Header comment (DO NOT EDIT)
 * - Theme rules: html[data-theme="dark"] { --color-bg: #000; ... }
 * - Metadata: :root { --theme-list: "default,dark,..."; --theme-dark-name: "Dark"; }
 */
import fs from "node:fs";
import path from "node:path";
import {
  exclude,
  filter,
  join,
  map,
  pipe,
  sortBy,
  split,
} from "#toolkit/fp/array.js";
import { memoize } from "#toolkit/fp/memoize.js";

/** @typedef {{ name: string, file: string, content: string }} ThemeFile */

const THEMES_DIR = path.resolve("src/css");
const EXCLUDED_FILES = [
  "theme-editor.scss",
  "theme-switcher.scss",
  "theme-switcher-compiled.scss",
];

const getThemeFiles = memoize(() =>
  pipe(
    filter((file) => file.startsWith("theme-") && file.endsWith(".scss")),
    exclude(EXCLUDED_FILES),
    map((file) => ({
      name: file.replace("theme-", "").replace(".scss", ""),
      file,
      content: fs.readFileSync(path.join(THEMES_DIR, file), "utf8"),
    })),
    sortBy("name"),
  )(fs.readdirSync(THEMES_DIR)),
);

const generateThemeSwitcherContent = memoize(() => {
  const themes = getThemeFiles();

  const header = `// Auto-generated theme definitions for theme switcher
// Generated from individual theme-*.scss files
// DO NOT EDIT - This file is automatically generated during build`;

  const themeRules = themes.map(
    /** @param {ThemeFile} theme */
    (theme) => {
      const variables = theme.content.match(/:root\s*{([^}]+)}/)?.[1] ?? "";
      return `html[data-theme="${theme.name}"] {${variables}}`;
    },
  );

  const themeList = [
    "default",
    ...themes.map(/** @param {ThemeFile} t */ (t) => t.name),
  ];
  const displayNames = themes.map(
    /** @param {ThemeFile} theme */
    (theme) => {
      const displayName = pipe(
        split("-"),
        map((word) => word.charAt(0).toUpperCase() + word.slice(1)),
        join(" "),
      )(theme.name);
      return `  --theme-${theme.name}-name: "${displayName}";`;
    },
  );

  const metadata = `// Theme metadata for JavaScript access
:root {
  --theme-list: "${themeList.join(",")}";
  --theme-default-name: "Default";
${displayNames.join("\n")}
}`;

  return [header, ...themeRules, metadata].join("\n\n");
});

export { generateThemeSwitcherContent };
