import fs from "node:fs";
import path from "node:path";
import { memoize } from "#utils/memoize.js";
import { slugToTitle } from "#utils/slug-utils.js";

// Get all theme files and their names
const getThemeFiles = memoize(() => {
  const themesDir = path.resolve("src/css");
  const files = fs.readdirSync(themesDir);

  const themes = files
    .filter(
      (file) =>
        file.startsWith("theme-") &&
        file !== "theme-switcher.scss" &&
        file !== "theme-switcher-compiled.scss" &&
        file.endsWith(".scss"),
    )
    .map((file) => {
      const name = file.replace("theme-", "").replace(".scss", "");
      const content = fs.readFileSync(path.join(themesDir, file), "utf8");
      return { name, file, content };
    })
    .sort((a, b) => a.name.localeCompare(b.name)); // Sort alphabetically

  return themes;
});

// Extract CSS variables from :root block
const extractRootVariables = (content) => {
  // Match the :root block and extract its contents
  const rootMatch = content.match(/:root\s*{([^}]+)}/);
  if (!rootMatch) return "";

  // Return just the variable declarations (without the :root wrapper)
  return rootMatch[1];
};

// Generate compiled theme CSS for theme-switcher
const generateThemeSwitcherContent = memoize(() => {
  const themes = getThemeFiles();

  const header = `// Auto-generated theme definitions for theme switcher
// Generated from individual theme-*.scss files
// DO NOT EDIT - This file is automatically generated during build`;

  // Generate theme CSS rules using theme names as identifiers
  const themeRules = themes.map((theme) => {
    const variables = extractRootVariables(theme.content);
    return `html[data-theme="${theme.name}"] {${variables}}`;
  });

  // Generate theme list as CSS custom property for JavaScript access
  const themeList = ["default", ...themes.map((t) => t.name)];
  const displayNames = themes.map(
    (theme) => `  --theme-${theme.name}-name: "${slugToTitle(theme.name)}";`,
  );

  const metadata = `// Theme metadata for JavaScript access
:root {
  --theme-list: "${themeList.join(",")}";
  --theme-default-name: "Default";
${displayNames.join("\n")}
}`;

  return [header, ...themeRules, metadata].join("\n\n");
});

export {
  extractRootVariables,
  generateThemeSwitcherContent,
  getThemeFiles,
  slugToTitle,
};
