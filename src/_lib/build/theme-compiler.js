/**
 * Theme compiler - generates combined CSS from individual theme-*.scss files.
 *
 * Reads theme files from src/css/, extracts CSS variables from :root blocks,
 * and generates a theme-switcher stylesheet with:
 * - html[data-theme="name"] selectors for each theme
 * - Theme metadata in CSS custom properties for JavaScript access
 *
 * Output format (generated SCSS):
 * - Header comment (DO NOT EDIT)
 * - Theme rules: html[data-theme="dark"] { --color-bg: #000; ... }
 * - Metadata: :root { --theme-list: "default,dark,..."; --theme-dark-name: "Dark"; }
 */
import fs from "node:fs";
import path from "node:path";
import { memoize } from "#utils/memoize.js";
import { slugToTitle } from "#utils/slug-utils.js";

const getThemeFiles = memoize(() => {
  const themesDir = path.resolve("src/css");
  const files = fs.readdirSync(themesDir);

  const themes = files
    .filter(
      (file) =>
        file.startsWith("theme-") &&
        file !== "theme-switcher.scss" &&
        file !== "theme-switcher-compiled.scss" &&
        file.endsWith(".scss"),
    )
    .map((file) => {
      const name = file.replace("theme-", "").replace(".scss", "");
      const content = fs.readFileSync(path.join(themesDir, file), "utf8");
      return { name, file, content };
    })
    .sort((a, b) => a.name.localeCompare(b.name));

  return themes;
});

const generateThemeSwitcherContent = memoize(() => {
  const themes = getThemeFiles();

  const header = `// Auto-generated theme definitions for theme switcher
// Generated from individual theme-*.scss files
// DO NOT EDIT - This file is automatically generated during build`;

  const themeRules = themes.map((theme) => {
    const variables = theme.content.match(/:root\s*{([^}]+)}/)?.[1] ?? "";
    return `html[data-theme="${theme.name}"] {${variables}}`;
  });

  const themeList = ["default", ...themes.map((t) => t.name)];
  const displayNames = themes.map(
    (theme) => `  --theme-${theme.name}-name: "${slugToTitle(theme.name)}";`,
  );

  const metadata = `// Theme metadata for JavaScript access
:root {
  --theme-list: "${themeList.join(",")}";
  --theme-default-name: "Default";
${displayNames.join("\n")}
}`;

  return [header, ...themeRules, metadata].join("\n\n");
});

export { generateThemeSwitcherContent };
