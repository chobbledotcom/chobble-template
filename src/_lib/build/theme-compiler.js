/**
 * Theme compiler - generates combined CSS from individual theme-*.scss files.
 *
 * Reads theme files from src/css/, extracts CSS variables from :root blocks,
 * and generates a theme-switcher stylesheet with:
 * - html[data-theme="name"] selectors for each theme
 * - Theme metadata in CSS custom properties for JavaScript access
 *
 * Output format (generated SCSS):
 * - Header comment (DO NOT EDIT)
 * - Theme rules: html[data-theme="dark"] { --color-bg: #000; ... }
 * - Metadata: :root { --theme-list: "default,dark,..."; --theme-dark-name: "Dark"; }
 */
import fs from "node:fs";
import path from "node:path";
import { filter, map, notMemberOf, pipe, sort } from "#utils/array-utils.js";
import { memoize } from "#utils/memoize.js";
import { slugToTitle } from "#utils/slug-utils.js";
import { compareByLocale } from "#utils/sorting.js";

const THEMES_DIR = path.resolve("src/css");
const EXCLUDED_FILES = ["theme-switcher.scss", "theme-switcher-compiled.scss"];

const isThemeFile = (file) =>
  file.startsWith("theme-") && file.endsWith(".scss");

const toThemeData = (file) => ({
  name: file.replace("theme-", "").replace(".scss", ""),
  file,
  content: fs.readFileSync(path.join(THEMES_DIR, file), "utf8"),
});

const getThemeFiles = memoize(() =>
  pipe(
    filter(isThemeFile),
    filter(notMemberOf(EXCLUDED_FILES)),
    map(toThemeData),
    sort(compareByLocale((t) => t.name)),
  )(fs.readdirSync(THEMES_DIR)),
);

const extractRootVariables = (content) => {
  const rootMatch = content.match(/:root\s*{([^}]+)}/);
  if (!rootMatch) return "";
  return rootMatch[1];
};

const generateThemeSwitcherContent = memoize(() => {
  const themes = getThemeFiles();

  const header = `// Auto-generated theme definitions for theme switcher
// Generated from individual theme-*.scss files
// DO NOT EDIT - This file is automatically generated during build`;

  const themeRules = themes.map((theme) => {
    const variables = extractRootVariables(theme.content);
    return `html[data-theme="${theme.name}"] {${variables}}`;
  });

  const themeList = ["default", ...themes.map((t) => t.name)];
  const displayNames = themes.map(
    (theme) => `  --theme-${theme.name}-name: "${slugToTitle(theme.name)}";`,
  );

  const metadata = `// Theme metadata for JavaScript access
:root {
  --theme-list: "${themeList.join(",")}";
  --theme-default-name: "Default";
${displayNames.join("\n")}
}`;

  return [header, ...themeRules, metadata].join("\n\n");
});

export { generateThemeSwitcherContent };
