{%- comment -%}
Block processor for design system pages.

Iterates through blocks array and renders each block type.
Supports optional section and container wrapping:
  - section_class: Wraps block in <section class="...">
  - container: Wraps in <div class="container"> (or container--default, etc.)

For landing pages, set landing_page: true to wrap in <main> element
and render footer outside main.
{%- endcomment -%}

{%- if blocks.size > 0 -%}
{%- assign _layout = pageLayouts[page.fileSlug] -%}
{%- assign _inMain = false -%}
{%- assign _footerBlock = nil -%}

{%- comment -%} Find footer block if landing_page mode {%- endcomment -%}
{%- if landing_page -%}
  {%- for block in blocks -%}
    {%- if block.type == "footer" -%}
      {%- assign _footerBlock = block -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}

{%- comment -%} Start main wrapper for landing pages {%- endcomment -%}
{%- if landing_page -%}
<main>
{%- else -%}
<div class="design-system">
{%- endif -%}

{%- for block in blocks -%}
  {%- assign _layoutBlock = _layout.blocks[forloop.index0] -%}

  {%- comment -%} Skip footer in main loop for landing pages - rendered after main {%- endcomment -%}
  {%- if landing_page and block.type == "footer" -%}
    {%- continue -%}
  {%- endif -%}

  {%- comment -%} Section wrapper opening {%- endcomment -%}
  {%- if block.section_class != nil -%}
<section{% if block.section_class != "" %} class="{{ block.section_class }}"{% endif %}>
  {%- endif -%}

  {%- comment -%} Container wrapper opening {%- endcomment -%}
  {%- if block.container -%}
    {%- if block.container == true or block.container == "default" -%}
<div class="container">
    {%- else -%}
<div class="container--{{ block.container }}">
    {%- endif -%}
  {%- endif -%}

  {%- case block.type -%}

    {%- when "section-header" -%}
      {%- assign _level = _layoutBlock.level | default: block.level | default: 2 -%}
      {%- assign _align = _layoutBlock.align | default: block.align | default: "center" -%}
      {%- include "design-system/section-header.html",
          title: block.title,
          subtitle: block.subtitle,
          level: _level,
          align: _align,
          class: block.class
      -%}

    {%- when "features" -%}
      {%- assign _heading_level = _layoutBlock.heading_level | default: block.heading_level | default: 3 -%}
      {%- assign _grid_class = block.grid_class | default: "features" -%}
      {%- if block.reveal == false -%}
        {%- assign _reveal = false -%}
      {%- else -%}
        {%- assign _reveal = true -%}
      {%- endif -%}
      {%- include "design-system/features.html",
          items: block.items,
          reveal: _reveal,
          heading_level: _heading_level,
          grid_class: _grid_class,
          header_title: block.header_title,
          header_subtitle: block.header_subtitle
      -%}

    {%- when "image-cards" -%}
      {%- assign _heading_level = _layoutBlock.heading_level | default: block.heading_level | default: 3 -%}
      {%- assign _image_aspect_ratio = _layoutBlock.image_aspect_ratio | default: block.image_aspect_ratio -%}
      {%- include "design-system/image-cards.html",
          items: block.items,
          reveal: block.reveal,
          heading_level: _heading_level,
          image_aspect_ratio: _image_aspect_ratio
      -%}

    {%- when "stats" -%}
      {%- if block.reveal == false -%}
        {%- assign _reveal = false -%}
      {%- else -%}
        {%- assign _reveal = true -%}
      {%- endif -%}
      {%- include "design-system/stats.html",
          items: block.items,
          reveal: _reveal
      -%}

    {%- when "code-block" -%}
      {%- include "design-system/code-block.html",
          filename: block.filename,
          code: block.code,
          language: block.language,
          reveal: block.reveal
      -%}

    {%- when "hero" -%}
      {%- include "design-system/hero.html",
          badge: block.badge,
          title: block.title,
          lead: block.lead,
          buttons: block.buttons,
          class: block.class,
          reveal: block.reveal
      -%}

    {%- when "split" -%}
      {%- assign _title_level = _layoutBlock.title_level | default: block.title_level | default: 2 -%}
      {%- if block.reveal_content -%}
        {%- assign _reveal_content = block.reveal_content -%}
      {%- elsif block.reverse -%}
        {%- assign _reveal_content = "right" -%}
      {%- else -%}
        {%- assign _reveal_content = "left" -%}
      {%- endif -%}
      {%- assign _reveal_figure = block.reveal_figure | default: "scale" -%}
      {%- include "design-system/split.html",
          title: block.title,
          title_level: _title_level,
          subtitle: block.subtitle,
          content: block.content,
          figure_type: block.figure_type,
          figure_content: block.figure_content,
          reverse: block.reverse,
          reveal_content: _reveal_content,
          reveal_figure: _reveal_figure,
          button: block.button
      -%}

    {%- when "cta" -%}
      {%- include "design-system/cta.html",
          title: block.title,
          description: block.description,
          button: block.button,
          reveal: block.reveal
      -%}

    {%- when "footer" -%}
      {%- include "design-system/footer.html",
          text: block.text,
          links: block.links,
          aria_label: block.aria_label
      -%}

    {%- when "markdown" -%}
      {{ block.content | renderContent: "md" }}

    {%- when "html" -%}
      {{ block.content }}

  {%- endcase -%}

  {%- comment -%} Container wrapper closing {%- endcomment -%}
  {%- if block.container -%}
</div>
  {%- endif -%}

  {%- comment -%} Section wrapper closing {%- endcomment -%}
  {%- if block.section_class != nil -%}
</section>
  {%- endif -%}

{%- endfor -%}

{%- comment -%} Close main wrapper {%- endcomment -%}
{%- if landing_page -%}
</main>
{%- else -%}
</div>
{%- endif -%}

{%- comment -%} Render footer after main for landing pages {%- endcomment -%}
{%- if _footerBlock -%}
  {%- include "design-system/footer.html",
      text: _footerBlock.text,
      links: _footerBlock.links,
      aria_label: _footerBlock.aria_label
  -%}
{%- endif -%}

{%- endif -%}
