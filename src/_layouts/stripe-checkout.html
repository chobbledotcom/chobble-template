<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ meta_title | default: "Redirecting..." }}</title>
  <link rel="stylesheet" href="{{ '/css/bundle.css' | cacheBust }}">
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    .stripe-checkout-page {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
      padding: 2rem;
    }
    .stripe-checkout-page p {
      font-size: 1.25rem;
      margin: 0;
    }
    .stripe-checkout-page .error {
      color: #c41e3a;
    }
  </style>
</head>
<body>
  <main
    class="stripe-checkout-page"
    data-stripe-key="{{ config.stripe_publishable_key }}"
    data-checkout-api-url="{{ config.checkout_api_url }}"
  >
    <p id="status-message">Checking cart...</p>
  </main>

  <script>
    (function() {
      const STORAGE_KEY = "shopping_cart";
      const statusMessage = document.getElementById("status-message");
      const main = document.querySelector(".stripe-checkout-page");
      const stripeKey = main.dataset.stripeKey;
      const checkoutApiUrl = main.dataset.checkoutApiUrl;

      function getCart() {
        try {
          const cart = localStorage.getItem(STORAGE_KEY);
          return cart ? JSON.parse(cart) : [];
        } catch (e) {
          console.error("Error reading cart:", e);
          return [];
        }
      }

      function showError(message) {
        statusMessage.textContent = message;
        statusMessage.classList.add("error");
      }

      async function checkout() {
        const cart = getCart();

        // If cart is empty, redirect to homepage
        if (cart.length === 0) {
          statusMessage.textContent = "Redirecting to homepage...";
          window.location.href = "/";
          return;
        }

        // Check configuration
        if (!stripeKey) {
          showError("Stripe is not configured");
          return;
        }

        if (!checkoutApiUrl) {
          showError("Checkout backend is not configured");
          return;
        }

        statusMessage.textContent = "Redirecting to Stripe...";

        try {
          // Prepare cart items (SKU + quantity only)
          const items = cart.map(({ sku, quantity }) => ({ sku, quantity }));

          // Create Stripe session via backend
          const response = await fetch(`${checkoutApiUrl}/api/stripe/create-session`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ items }),
          });

          if (response.ok) {
            const session = await response.json();

            // Prefer direct URL redirect if available
            if (session.url) {
              window.location.href = session.url;
              return;
            }

            // Fall back to Stripe.js redirect
            if (session.id) {
              const stripe = Stripe(stripeKey);
              const result = await stripe.redirectToCheckout({
                sessionId: session.id,
              });

              if (result.error) {
                showError(result.error.message);
              }
              return;
            }

            showError("Invalid response from server");
          } else {
            const error = await response.json();
            showError(error.error || "Failed to create checkout session");
          }
        } catch (error) {
          console.error("Stripe checkout failed:", error);
          showError("Failed to start checkout. Please try again.");
        }
      }

      // Run checkout on page load
      checkout();
    })();
  </script>
</body>
</html>
