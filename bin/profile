#!/usr/bin/env bash
#
# Profile the Eleventy build to find performance bottlenecks
#
# Usage:
#   ./bin/profile          # Run profiling and generate reports
#   ./bin/profile --open   # Open in speedscope after profiling
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
PROFILE_DIR="$PROJECT_DIR/.profile"
PROFILE_FILE="$PROFILE_DIR/build.cpuprofile"

# Clean up and create profile directory
rm -rf "$PROFILE_DIR"
mkdir -p "$PROFILE_DIR"

echo "=== Profiling Eleventy Build ==="
echo ""

cd "$PROJECT_DIR"
rm -rf _site

# Run build with CPU profiling
# Note: --cpu-prof-dir and --cpu-prof-name don't work reliably in Bun,
# so we find the generated file and move it manually
bun --cpu-prof node_modules/@11ty/eleventy/cmd.cjs

echo ""

# Find the generated profile (Bun creates CPU.*.cpuprofile in cwd)
GENERATED_PROFILE=$(ls -t "$PROJECT_DIR"/CPU.*.cpuprofile 2>/dev/null | head -1)

if [[ -z "$GENERATED_PROFILE" ]]; then
  echo "Error: CPU profile not generated."
  echo "Try running directly: bun --cpu-prof node_modules/@11ty/eleventy/cmd.cjs"
  exit 1
fi

mv "$GENERATED_PROFILE" "$PROFILE_FILE"

echo "Generating report..."
bun "$SCRIPT_DIR/profile-report.js" "$PROFILE_FILE" "$PROFILE_DIR/report.txt" "$PROJECT_DIR"

echo ""
echo "Profile saved to: .profile/build.cpuprofile"
echo "Report saved to:  .profile/report.txt"

if [[ "$1" == "--open" ]]; then
  echo ""
  bunx speedscope "$PROFILE_FILE"
fi
